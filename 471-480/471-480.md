# 471 - 595a093 chore 删除debugger

undef的hmr accept重构PR忘记删除了`debugger`



# 472 - ef4fc42 支持无参数直接调用`hot.accept()` & 支持分析`es2020 importMeta`

如在testHmrManual.js调用如下：

`hot.accept() -> hot.accept("/testHmrManual.js", "/testHmrManual.js", )`

> 防止错误发生，即防止用户调用`hot.accept()`后项目无法启动，引起更多的issues。



# 473 - b62af73 更新注释

曾经改动过收集`SFC`文件的集合变量名称。

`vueImports` -> `vueBoundaries`



# 474 - 5b75f56 `esbuildPlugin`前进行用户`transform`

洋葱模型顺序更新。

```typescript
// 改动前：
const resolvedPlugins = [
    ...(Array.isArray(configureServer) ? configureServer : [configureServer]),
    proxyPlugin,
    serviceWorkerPlugin,
    hmrPlugin,
    moduleRewritePlugin,
    moduleResolvePlugin,
    vuePlugin,
    esbuildPlugin,
    jsonPlugin,
    cssPlugin,
    assetPathPlugin,
    ...(transforms.length ? [createServerTransformPlugin(transforms)] : []),
    serveStaticPlugin
  ]

// 改动后：
  const resolvedPlugins = [
    ...(Array.isArray(configureServer) ? configureServer : [configureServer]),
    proxyPlugin,
    serviceWorkerPlugin,
    hmrPlugin,
    moduleRewritePlugin,
    moduleResolvePlugin,
    vuePlugin,
    cssPlugin, // 被提前（因为含有config.transforms）
    ...(transforms.length ? [createServerTransformPlugin(transforms)] : []), // 被提前
    esbuildPlugin,
    jsonPlugin,
    assetPathPlugin,
    serveStaticPlugin
  ]
```

> 意味着我们可以直接更改ts代码，曾经只能更改由esbuild转换ts后的js代码



# 475 - ce4032b 传递`path isBuild query`给`transform`

改动部分：

- `node/transform.ts`：新增`transform`传入的参数（详 **改动一**）
- `node/build/buildPluginCss.ts`：新增参数，对应改动一`t.transform(css, true, true, path, query)`，即代表构建状态、当前路径（requestId）、参数（requestId后的参数，如构建模式下`import from 'a?query=123'`）
- `node/build/index.ts`：添加备注，用户可以不设置`knowNamedExports`通过升级`@rollup/plugin-commonjs`，这也是之前我无法查阅到相关字段的原因。[传送门](https://github.com/Kingbultsea/vite-analysis/blob/8b8276edfe2c70f04a663de96b73bf202ef41546/431-440/431-440.md#%E5%86%8D%E8%AF%A6%E7%BB%86%E8%B0%88%E8%B0%88%E9%9C%80%E8%A6%81%E6%98%8E%E7%A1%AE%E8%A1%A8%E7%A4%BA%E5%AF%BC%E5%87%BA%E5%91%BD%E5%90%8D%E7%9A%84%E4%BE%8B%E5%AD%90)

> 在`serverPluginCss.ts`的`transform`仅仅起到一个`hmr`的作用，如非`.css`的文件可以走`.css`的`hmr`流程。

### 改动一 新增`transform`的参数给用户

```typescript
export interface Transform {
  /**
   * @default 'js'
   */
  as?: 'js' | 'css'
  test: (path: string, query: ParsedQuery) => boolean
  transform: (
    code: string,
    /**
     * Indicates whether this is a request made by js import(), or natively by
     * the browser (e.g. `<img src="...">`).
     */
    isImport: boolean,
    isBuild: boolean, // 是否构建模式
    path: string, // 当前路径构建模式： import 'a' -> 那path为'a' 如果为serve模式 则为publicPath,那path为'@modules/a'
    query: ParsedQuery // 当前路径 import 'a?query=1' -> 那path为'?query=1'
  ) => string | Promise<string>
}
```



# 476 - c244cc7 resolver类型

`resolver`的`requestToFile`和`fileToRequest`方法为可选，即用户定义`resolver`的时候不强制类型上要定义这两个方法



# 477 - 86e9fb5 修复依赖优化的缓存路径设置问题

改动部分：

`cli.ts`：对用户使用`cli`传入相对路径的处理
