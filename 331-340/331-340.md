# 331 - 6cf1e31 issue æ¨¡æ¿

## Before you continue...

å¦‚æœä½ å‡çº§`Vite`åï¼Œå‡ºç°äº†é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨æµè§ˆå™¨åˆ é™¤ç¼“å­˜ï¼Œå‹¾é€‰â€œDisable cache"



# 332 - a4524b4 ä¿®å¤`hmr hot.on`å›è°ƒå‚æ•°ç±»å‹

`on`å¯ä»¥ç»‘å®šäº‹ä»¶åç§°å’Œå›è°ƒçš„å…³ç³»ï¼Œ`hmr` `custom`äº‹ä»¶å¯ä»¥æ ¹æ®serverç«¯ä¼ å…¥çš„`id`äº‹ä»¶åç§°ï¼Œè§¦å‘å›è°ƒã€‚

![1](1.png)



# 333 - 86d550a æ”¯æŒ`config` `alias`

æ”¹åŠ¨éƒ¨åˆ†ï¼š

- `node/resolver.ts`ï¼šå»é™¤`idToRequest`ï¼Œæ–°å¢`alias`ï¼ˆè¯¦ **æ”¹åŠ¨ä¸€**ï¼‰
- `node/server/index.ts`åŠ å…¥`alias`
- `node/build/index.ts`åŠ å…¥`alias`
- `node/config.ts`è¾“å‡º`export { Resolver }`ç±»å‹ï¼ˆè¯¦ **æ”¹åŠ¨å››**ï¼‰

## æ”¹åŠ¨ä¸€

1. **åºŸå¼ƒ**`idToRequest`ï¼Œè¯¥åŠŸèƒ½å¯ä»¥å¸®åŠ©æˆ‘ä»¬idè½¬æ¢ä¸ºrequestè·¯å¾„ï¼ˆå¼€å‘å’Œæ„å»ºéƒ½ç”¨åˆ°ï¼‰ï¼Œå³import a from 'id' -> import a from '/@modules/id'ï¼Œæˆ‘ä»¬å¯ä»¥æ“æ§å…¶è½¬æ¢ä¸º'/@modules/id' -> '/@modules/aid'ã€‚ç®€å•æ¥è¯´å°±æ˜¯`vite`éœ€è¦æ”¹å†™ä½ çš„è·¯å¾„ï¼Œä½ ä½¿ç”¨`idToRequest`æ‹¦æˆªäº†è¯¥è¡Œä¸ºã€‚

> åˆ«é—®ä¸ºä»€ä¹ˆè¦æ”¹å†™è·¯å¾„ï¼Œä¸æ”¹å†™æµè§ˆå™¨è¯·æ±‚åˆ°æ—¶å€™é‡æ–°ä¼ å…¥`vite`åˆ†æä¸äº†ä½ çš„æ¨¡å—ç±»å‹ï¼Œ`import 'a'` å’Œ `import '/a'`ï¼Œç»™åˆ°æµè§ˆå™¨è¯·æ±‚å›æ¥éƒ½æ˜¯`localhost:8080/a`ï¼Œç„¶é¹…å‰è€…æ˜¯æ¨¡å—ï¼Œåè€…æ˜¯ç»å¯¹è·¯å¾„çš„aæ–‡ä»¶ã€‚ä¸ä¿¡ä½ è‡ªå·±è¯•è¯•ğŸ¤¨ï¼Œåæ­£æˆ‘æ²¡è¯•ï¼Œè›¤è›¤è›¤ã€‚

2. æ–°å¢`alias`ï¼Œé¡¶æ›¿`idToRequest`ä½œç”¨ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯å¯¹è±¡ï¼Œå³æ˜ å°„id -> ç”¨æˆ·æƒ³è¦çš„idï¼Œã€‚

```typescript
export function createResolver(
  root: string,
  resolvers: Resolver[],
  alias: Record<string, string> // æ–°å¢å‚æ•°
): InternalResolver {
  return {
    // ...  
    alias: (id: string) => {
      let aliased: string | undefined = alias[id]
      if (aliased) {
        return aliased
      }
      for (const r of resolvers) {
        aliased = r.alias && r.alias(id)
        if (aliased) {
          return aliased
        }
      }
    }
  }
}
```

#### `idToRequest`ä¸å°±å¯ä»¥äº†ï¼Ÿä¸ºä»€ä¹ˆè¦alias?

`idToRequest`éœ€è¦æ˜ å°„åçš„è·¯å¾„ç¬¦åˆ`vite`çš„æ”¹å†™ï¼Œå¼€å‘è€…ä½¿ç”¨èµ·æ¥**ä¸æ–¹ä¾¿**ï¼ˆå¼€å‘è€…ä¸ä¸€å®šä¼šçœ‹æºç ï¼Œéœ€è¦æé†’æ·»åŠ `@modules/`ï¼‰ï¼Œæ¯”å¦‚æˆ‘æƒ³è¦æ”¹å†™`a`ä¸º`b`æ¨¡å—ï¼Œæˆ‘éœ€è¦è¿”å›`@modules/b`ã€‚ï¼ˆæ„å»ºæ¨¡å¼ä¸‹ï¼Œ`@/modules`ä¼šè¢«`requestToFile`å»é™¤ï¼‰

`alias`ï¼Œåˆ©ç”¨å¯¹è±¡åšæ˜ å°„å…³ç³»ï¼Œä¸”æ”¹ç‰ˆåï¼ˆä¸æ˜¯aliasï¼‰ï¼Œå¼€å‘è€…ä¸éœ€è¦æ·»åŠ `@modules`äº†ã€‚

## æ”¹åŠ¨å››

è¾“å‡ºResolverç±»å‹ï¼Œæä¾›ç”¨æˆ·å®šä¹‰Resolverã€‚

```typescript
export interface Resolver {
  requestToFile(publicPath: string, root: string): string | undefined
  fileToRequest(filePath: string, root: string): string | undefined
  alias?(id: string): string | undefined
}
```



# 334 - b85de93 ä¿®å¤åŠ è½½tsç±»å‹çš„config

ç”±äºå…ˆå‰åˆ¤æ–­ç”¨æˆ·æ²¡æœ‰è®¾ç½®`configPath`ï¼Œé»˜è®¤ä¸º`vite.config.js`ï¼Œç„¶ååˆ©ç”¨`await fs.pathExists(resolvedPath)`å¯»æ‰¾æ˜¯å¦æœ‰è¯¥æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ™ä¸åšä»»ä½•äº‹æƒ…ã€‚

ç°åœ¨åˆ¤æ–­æœ‰æ²¡æœ‰`js`å†åˆ¤æ–­æœ‰æ²¡æœ‰`ts`å°±å¥½ã€‚

![2](2.png)



# 335 - b7b9d85 æ·»åŠ aliasæµ‹è¯•

æ³¨æ„å“ˆï¼Œè¯¥æµ‹è¯•å†™äº†æ˜ å°„ä¸º`/aliased`ï¼Œæ‰€ä»¥ä¸æ˜¯æ¨¡å—ï¼Œä¸è¦è¯¯ä¼šè®¤ä¸º`alias`ä¸ä¼šè¢«å½“ä½œæ¨¡å—ã€‚

```typescript
# vite.config.ts
alias: {
    alias: '/aliased'
}

# TestAlias.vue
import { msg } from 'alias'

# aliased
export const msg = 'alias works.'
```



# 336 - 87ee998 æ”¯æŒtransform config

æ”¯æŒé€šè¿‡viteç‰¹è‰²çš„pluginsæ”¹å˜ä»£ç ï¼Œå…ˆçœ‹å®ç°åŠŸèƒ½ç›®æ ‡æµ‹è¯•ä¾‹å­ï¼š

```typescript
# vite.config,ts
import type { UserConfig } from 'vite'
import { sassPlugin } from './plugins/sassPlugin'
import { jsPlugin } from './plugins/jsPlugin'

const config: UserConfig = {
  alias: {
    alias: '/aliased'
  },
  jsx: {
    factory: 'h',
    fragment: 'Fragment'
  },
  minify: false,
  plugins: [sassPlugin, jsPlugin]
}

export default config

# jsPlugin.js viteç‰¹è‰²æ’ä»¶
export const jsPlugin = {
  transforms: [
    {
      test(id) {
        return id.endsWith('testTransform.js')
      },
      transform(code) {
        return code.replace(/__TEST_TRANSFORM__ = (\d)/, (matched, n) => {
          return `__TEST_TRANSFORM__ = ${Number(n) + 1}`
        })
      }
    }
  ]
}

# sassPlugin.js viteç‰¹è‰²æ’ä»¶
import sass from 'sass'

export const sassPlugin = {
  transforms: [
    {
      as: 'css',
      test(id) {
        return id.endsWith('.scss')
      },
      transform(code) {
        return sass
          .renderSync({
            data: code
          })
          .css.toString()
      }
    }
  ]
}

# TestTransform.vue
<template>
  <h2>Transforms</h2>
  <div class="transform-scss">This should be cyan</div>
  <div class="transform-js">{{ transformed }}</div>
</template>

<script>
import './testTransform.scss'
import { __TEST_TRANSFORM__ } from './testTransform.js'

export default {
  data() {
    return {
      transformed: __TEST_TRANSFORM__
    }
  }
}
</script>
```

> è¯¥ç¤ºä¾‹é…ç½®äº†ä¸¤ä¸ªviteçš„æ’ä»¶ï¼Œæƒ³é€šè¿‡sassè½¬æ¢scssæ–‡ä»¶ä»£ç ï¼Œè½¬æ¢ç‰¹å®šå˜é‡ã€‚

æ”¹åŠ¨éƒ¨åˆ†ï¼š

