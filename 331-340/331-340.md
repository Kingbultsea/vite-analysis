# 331 - 6cf1e31 issue æ¨¡æ¿

## Before you continue...

å¦‚æœä½ å‡çº§`Vite`åï¼Œå‡ºç°äº†é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨æµè§ˆå™¨åˆ é™¤ç¼“å­˜ï¼Œå‹¾é€‰â€œDisable cache"



# 332 - a4524b4 ä¿®å¤`hmr hot.on`å›è°ƒå‚æ•°ç±»å‹

`on`å¯ä»¥ç»‘å®šäº‹ä»¶åç§°å’Œå›è°ƒçš„å…³ç³»ï¼Œ`hmr` `custom`äº‹ä»¶å¯ä»¥æ ¹æ®serverç«¯ä¼ å…¥çš„`id`äº‹ä»¶åç§°ï¼Œè§¦å‘å›è°ƒã€‚

![1](1.png)



# 333 - 86d550a æ”¯æŒ`config` `alias`

æ”¹åŠ¨éƒ¨åˆ†ï¼š

- `node/resolver.ts`ï¼šå»é™¤`idToRequest`ï¼Œæ–°å¢`alias`ï¼ˆè¯¦ **æ”¹åŠ¨ä¸€**ï¼‰
- `node/server/index.ts`åŠ å…¥`alias`
- `node/build/index.ts`åŠ å…¥`alias`
- `node/config.ts`è¾“å‡º`export { Resolver }`ç±»å‹ï¼ˆè¯¦ **æ”¹åŠ¨å››**ï¼‰

## æ”¹åŠ¨ä¸€

1. **åºŸå¼ƒ**`idToRequest`ï¼Œè¯¥åŠŸèƒ½å¯ä»¥å¸®åŠ©æˆ‘ä»¬idè½¬æ¢ä¸ºrequestè·¯å¾„ï¼ˆå¼€å‘å’Œæ„å»ºéƒ½ç”¨åˆ°ï¼‰ï¼Œå³import a from 'id' -> import a from '/@modules/id'ï¼Œæˆ‘ä»¬å¯ä»¥æ“æ§å…¶è½¬æ¢ä¸º'/@modules/id' -> '/@modules/aid'ã€‚ç®€å•æ¥è¯´å°±æ˜¯`vite`éœ€è¦æ”¹å†™ä½ çš„è·¯å¾„ï¼Œä½ ä½¿ç”¨`idToRequest`æ‹¦æˆªäº†è¯¥è¡Œä¸ºã€‚

> åˆ«é—®ä¸ºä»€ä¹ˆè¦æ”¹å†™è·¯å¾„ï¼Œä¸æ”¹å†™æµè§ˆå™¨è¯·æ±‚åˆ°æ—¶å€™é‡æ–°ä¼ å…¥`vite`åˆ†æä¸äº†ä½ çš„æ¨¡å—ç±»å‹ï¼Œ`import 'a'` å’Œ `import '/a'`ï¼Œç»™åˆ°æµè§ˆå™¨è¯·æ±‚å›æ¥éƒ½æ˜¯`localhost:8080/a`ï¼Œç„¶é¹…å‰è€…æ˜¯æ¨¡å—ï¼Œåè€…æ˜¯ç»å¯¹è·¯å¾„çš„aæ–‡ä»¶ã€‚ä¸ä¿¡ä½ è‡ªå·±è¯•è¯•ğŸ¤¨ï¼Œåæ­£æˆ‘æ²¡è¯•ï¼Œè›¤è›¤è›¤ã€‚

2. æ–°å¢`alias`ï¼Œé¡¶æ›¿`idToRequest`ä½œç”¨ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯å¯¹è±¡ï¼Œå³æ˜ å°„id -> ç”¨æˆ·æƒ³è¦çš„idï¼Œã€‚

```typescript
export function createResolver(
  root: string,
  resolvers: Resolver[],
  alias: Record<string, string> // æ–°å¢å‚æ•°
): InternalResolver {
  return {
    // ...  
    alias: (id: string) => {
      let aliased: string | undefined = alias[id]
      if (aliased) {
        return aliased
      }
      for (const r of resolvers) {
        aliased = r.alias && r.alias(id)
        if (aliased) {
          return aliased
        }
      }
    }
  }
}
```

#### `idToRequest`ä¸å°±å¯ä»¥äº†ï¼Ÿä¸ºä»€ä¹ˆè¦alias?

`idToRequest`éœ€è¦æ˜ å°„åçš„è·¯å¾„ç¬¦åˆ`vite`çš„æ”¹å†™ï¼Œå¼€å‘è€…ä½¿ç”¨èµ·æ¥**ä¸æ–¹ä¾¿**ï¼ˆå¼€å‘è€…ä¸ä¸€å®šä¼šçœ‹æºç ï¼Œéœ€è¦æé†’æ·»åŠ `@modules/`ï¼‰ï¼Œæ¯”å¦‚æˆ‘æƒ³è¦æ”¹å†™`a`ä¸º`b`æ¨¡å—ï¼Œæˆ‘éœ€è¦è¿”å›`@modules/b`ã€‚ï¼ˆæ„å»ºæ¨¡å¼ä¸‹ï¼Œ`@/modules`ä¼šè¢«`requestToFile`å»é™¤ï¼‰

`alias`ï¼Œåˆ©ç”¨å¯¹è±¡åšæ˜ å°„å…³ç³»ï¼Œä¸”æ”¹ç‰ˆåï¼ˆä¸æ˜¯aliasï¼‰ï¼Œå¼€å‘è€…ä¸éœ€è¦æ·»åŠ `@modules`äº†ã€‚

## æ”¹åŠ¨å››

è¾“å‡ºResolverç±»å‹ï¼Œæä¾›ç”¨æˆ·å®šä¹‰Resolverã€‚

```typescript
export interface Resolver {
  requestToFile(publicPath: string, root: string): string | undefined
  fileToRequest(filePath: string, root: string): string | undefined
  alias?(id: string): string | undefined
}
```



# 334 - b85de93 ä¿®å¤åŠ è½½tsç±»å‹çš„config

ç”±äºå…ˆå‰åˆ¤æ–­ç”¨æˆ·æ²¡æœ‰è®¾ç½®`configPath`ï¼Œé»˜è®¤ä¸º`vite.config.js`ï¼Œç„¶ååˆ©ç”¨`await fs.pathExists(resolvedPath)`å¯»æ‰¾æ˜¯å¦æœ‰è¯¥æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ™ä¸åšä»»ä½•äº‹æƒ…ã€‚

ç°åœ¨åˆ¤æ–­æœ‰æ²¡æœ‰`js`å†åˆ¤æ–­æœ‰æ²¡æœ‰`ts`å°±å¥½ã€‚

![2](2.png)



# 335 - b7b9d85 æ·»åŠ aliasæµ‹è¯•

æ³¨æ„å“ˆï¼Œè¯¥æµ‹è¯•å†™äº†æ˜ å°„ä¸º`/aliased`ï¼Œæ‰€ä»¥ä¸æ˜¯æ¨¡å—ï¼Œä¸è¦è¯¯ä¼šè®¤ä¸º`alias`ä¸ä¼šè¢«å½“ä½œæ¨¡å—ã€‚

```typescript
# vite.config.ts
alias: {
    alias: '/aliased'
}

# TestAlias.vue
import { msg } from 'alias'

# aliased
export const msg = 'alias works.'
```



# 336 - 87ee998 æ”¯æŒtransform config / viteæ’ä»¶

æ”¯æŒé€šè¿‡**Viteç‰¹è‰²çš„plugins**æ”¹å˜ä»£ç ï¼Œå…ˆçœ‹å®ç°åŠŸèƒ½ç›®æ ‡æµ‹è¯•ä¾‹å­ï¼š

```typescript
# vite.config,ts
import type { UserConfig } from 'vite'
import { sassPlugin } from './plugins/sassPlugin'
import { jsPlugin } from './plugins/jsPlugin'

const config: UserConfig = {
  alias: {
    alias: '/aliased'
  },
  jsx: {
    factory: 'h',
    fragment: 'Fragment'
  },
  minify: false,
  plugins: [sassPlugin, jsPlugin]
}

export default config

# jsPlugin.js viteç‰¹è‰²æ’ä»¶
export const jsPlugin = {
  transforms: [
    {
      test(id) {
        return id.endsWith('testTransform.js')
      },
      transform(code) {
        return code.replace(/__TEST_TRANSFORM__ = (\d)/, (matched, n) => {
          return `__TEST_TRANSFORM__ = ${Number(n) + 1}`
        })
      }
    }
  ]
}

# sassPlugin.js viteç‰¹è‰²æ’ä»¶
import sass from 'sass'

export const sassPlugin = {
  transforms: [
    {
      as: 'css',
      test(id) {
        return id.endsWith('.scss')
      },
      transform(code) {
        return sass
          .renderSync({
            data: code
          })
          .css.toString()
      }
    }
  ]
}

# TestTransform.vue
<template>
  <h2>Transforms</h2>
  <div class="transform-scss">This should be cyan</div>
  <div class="transform-js">{{ transformed }}</div>
</template>

<script>
import './testTransform.scss'
import { __TEST_TRANSFORM__ } from './testTransform.js'

export default {
  data() {
    return {
      transformed: __TEST_TRANSFORM__
    }
  }
}
</script>
```

> è¯¥ç¤ºä¾‹é…ç½®äº†ä¸¤ä¸ªviteçš„æ’ä»¶ï¼Œæƒ³é€šè¿‡`sass`è½¬æ¢`.scss`æ–‡ä»¶ä»£ç ï¼Œè½¬æ¢ç‰¹å®šå˜é‡ã€‚

æ”¹åŠ¨éƒ¨åˆ†ï¼š

- `node/cli.ts`:  build & dev ç»Ÿä¸€ä½¿ç”¨`UserConfig`é€‰é¡¹ç±»å‹ï¼ˆ`BuildConfig`æ²¡æœ‰`ServerConfig`çš„`plugins`ï¼Œå³æ²¡æœ‰viteç‰¹è‰²çš„koaæ’ä»¶ï¼‰ï¼Œåˆå¹¶æ²¡æœ‰ä»»ä½•å½±å“ï¼Œå…¨æ˜¯å¯é€‰é¡¹ï¼Œå­—æ®µæ²¡æ²¡æœ‰å†²çªï¼Œä¸ç®¡æ˜¯buildè¿˜æ˜¯devï¼Œåªè´Ÿè´£è‡ªå·±çš„å­—æ®µå°±å¥½äº†ã€‚
- `node/build/buildPluginCss.ts`:  è¯†åˆ«æ–°å‚æ•°`transforms: Transform[]`ä¼ å…¥ï¼Œç­›é€‰å‡ºç¬¦åˆ`Transform.as === â€˜cssâ€™`çš„`Transform`ï¼Œå†æ¬¡ç¬¦åˆç­›é€‰`Transform.test(è·¯å¾„)`ï¼›ç¬¦åˆ`as`å’Œ`test`æ–¹æ³•çš„Transformï¼Œå³å¯è°ƒç”¨`Transform.transform`æ”¹å˜cssæ–‡ä»¶ã€‚
- `node/build/index.ts`ï¼šæ–°å¢é€‰é¡¹`transform`ï¼ˆ`SharedConfig`å·²ç»æœ‰äº†ï¼Œæ‰€ä»¥ç°åœ¨åªè¦å–å°±å¯ä»¥äº†ï¼Œå‰å‡ ä¸ªcommitè®²è§£è¿‡ï¼‰ï¼Œè¯¥é€‰é¡¹äº¤ç»™`buildPluginCss.ts`æ’ä»¶ä½¿ç”¨ï¼Œå³æä¾›ç»™cssèµ„æºæ„å»ºå¤„ç†å™¨ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯rollupæ’ä»¶ï¼Œ ` transform`ç”Ÿå‘½å‘¨æœŸé’©å­; **é™¤æ­¤ä¹‹å¤–è¿˜å¸®åŠ©ç”¨æˆ·å°è£…**å¸¦æœ‰`transform`çš„`rollupã€‚`
- `node/server/index.ts`: åŒbuildä¸€æ ·ï¼Œæ–°å¢`transform`é€‰é¡¹ï¼Œ**å¸®åŠ©ç”¨æˆ·å°è£…ä»…å¸¦æœ‰koaæ´‹è‘±æ¨¡å‹æ’ä»¶åŠŸèƒ½çš„viteç‰¹è‰²æ’ä»¶**ï¼ˆè¯¦ ä¸»è¦è¡¥å……ä¸€ä¸‹æ´‹è‘±æ¨¡å‹çš„æ‰§è¡Œé¡ºåº **æ”¹åŠ¨å››**ï¼‰ã€‚
- `node/server/serverPluginCss.ts`: `config.trnasforms`è½¬æ¢`css`ï¼Œå’Œ`buildPluginCss.ts`è¡Œä¸ºä¸€è‡´ã€‚å¯¹`config.transforms.test`åŒ¹é…åˆ°çš„æ–‡ä»¶è¿›è¡Œç›‘å¬ã€‚
- `node/server/serverPluginHmr.ts`:  `config.transform` `test`å­—æ®µåŒ¹é…åˆ°çš„`.XXX`æ–‡ä»¶ï¼Œä¸ä¼šè§¦å‘`handleJSReload`ï¼Œä»…`.module.css`å˜åŠ¨éœ€è¦è§¦å‘`handleJSReload`ï¼ˆå› ä¸ºæ˜¯`js`ï¼Œæ³¨å†Œå…³ç³»åœ¨`moduleRewritePlugin`å®Œæˆï¼Œè¯¥æ’ä»¶åœ¨ç¬¬ä¸‰å±‚å¤–å±‚ï¼Œç›®å‰æ¥è¯´æ˜¯æœ€åæ‰§è¡Œï¼Œäº¤ç»™`cssPlugin`è®¾ç½®`ctx.type = 'js'`ï¼‰------> **åæ­£æ„æ€å°±æ˜¯`.modules.css`æ‰è§¦å‘ï¼Œç»è¿‡è½¬æ¢çš„`.XXX`è§†ä¸ºæ™®é€š`.css`æ–‡ä»¶ã€‚** çœ‹æ–°å¢ä¸ƒï¼Œæœ‰è¯´æ˜ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚
- æ–°å¢`node/transform.ts`ï¼Œå°è£…ç”¨æˆ·ä¼ å…¥çš„config.transformsï¼Œè½¬æ¢ä¸º`dev`å’Œ`build`æ’ä»¶ã€‚ï¼ˆè¯¦ **æ–°å¢ä¸ƒ**ï¼‰

> rollupæ’ä»¶æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå³ä½¿æ˜¯asyncï¼Œä¹Ÿä¼šç­‰å¾…ä¸Šä¸€ä¸ªtransformçš„æ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œä¸‹ä¸€ä¸ªtransformï¼Œæ–‡æ¡£ä¸Šæœ‰ç‚¹ä¸æ¸…æ™°ï¼ˆæ¯•ç«Ÿä¸­åæ–‡åŒ–åšå¤§ç²¾æ·±~~~ï¼‰[transform resolveId](https://github.com/Kingbultsea/vite-analysis/blob/842e5ef132fa68d5e4fa8dcf480cd444b4b0c8f3/111-120/commit-111-120.md#112---1b0b4ba-%E9%85%8D%E7%BD%AE%E5%8C%96%E6%9E%84%E5%BB%BA)

### æ”¹åŠ¨å››

#### æ´‹è‘±æ¨¡å‹æ‰§è¡Œé¡ºåºï¼ˆæ›´æ–°-1ï¼‰

hmrPluginè¢«æé«˜åˆ°å†…ç½®æ’ä»¶çš„ç¬¬ä¸€å±‚ï¼Œ[eab49a4](https://github.com/Kingbultsea/vite-analysis/blob/ea4fb552986c95f4da44839e03a00192ce424139/291-300/291-300.md)ã€‚æ³¨æ„ï¼Œæ–‡ä»¶åç§°å‘½åä¸æ’ä»¶åç§°ä¸ä¸€æ ·ã€‚

```typescript
import { serveStaticPlugin } from './serverPluginServeStatic'
import { assetPathPlugin } from './serverPluginAssets'
import { cssPlugin } from './serverPluginCss'
import { jsonPlugin } from './serverPluginJson'
import { esbuildPlugin } from './serverPluginEsbuild'
import { vuePlugin } from './serverPluginVue'
import { moduleRewritePlugin } from './serverPluginModuleRewrite'
import { moduleResolvePlugin } from './serverPluginModuleResolve'
import { hmrPlugin, HMRWatcher } from './serverPluginHmr'

# node/server.ts
const internalPlugins: Plugin[] = [
  ...config.plugins,     // æ´‹è‘±æ¨¡å‹çš„ç¬¬ä¸€å±‚  ï¼ˆè‡ªå®šï¼‰
  hmrPlugin,             // æ´‹è‘±æ¨¡å‹çš„ç¬¬äºŒå±‚  ï¼ˆé‡Œå±‚ï¼‰  
  moduleRewritePlugin,   // æ´‹è‘±æ¨¡å‹çš„ç¬¬ä¸‰å±‚  ï¼ˆå¤–å±‚ï¼‰ --
  moduleResolvePlugin,   // æ´‹è‘±æ¨¡å‹çš„ç¬¬å››å±‚  ï¼ˆé‡Œå±‚ï¼‰
  vuePlugin,             // æ´‹è‘±æ¨¡å‹çš„ç¬¬äº”å±‚  ï¼ˆå†…å±‚ï¼‰
  esbuildPlugin,         // æ´‹è‘±æ¨¡å‹çš„ç¬¬å…­å±‚  ï¼ˆå¤–å±‚ï¼‰ --
  jsonPlugin,            // æ´‹è‘±æ¨¡å‹çš„ç¬¬ä¸ƒå±‚  ï¼ˆå¤–å±‚ï¼‰ --
  cssPlugin,             // æ´‹è‘±æ¨¡å‹çš„ç¬¬å…«å±‚  ï¼ˆå¤–å±‚ï¼‰ --
  assetPathPlugin        // æ´‹è‘±æ¨¡å‹çš„ç¬¬ä¹å±‚  ï¼ˆé‡Œå±‚ï¼‰ 
  ServerTransformPlugin, // æ´‹è‘±æ¨¡å‹çš„ç¬¬åå±‚  ï¼ˆå¤–å±‚ï¼‰ -- 
  serveStaticPlugin      // æ´‹è‘±æ¨¡å‹çš„ç¬¬åä¸€å±‚ï¼ˆé‡Œå±‚ï¼‰
]
```

`hmrPlugin`: åˆå§‹åŒ–wsï¼›**æ´‹è‘±æ¨¡å‹**ä¸­ï¼Œä»…å‘é€`path.resolve(__dirname, '../client.js')`æ–‡ä»¶

`moduleRewritePlugin`:  **æ´‹è‘±æ¨¡å‹**ä¸­ï¼Œæ”¹å†™`import`è¯­å¥ã€å‘é€è¢«æ”¹é€ åçš„`index.html`

`moduleResolvePlugin`: **æ´‹è‘±æ¨¡å‹**ä¸­ï¼Œå¤„ç†`vue`ã€ `web_modules` å’Œ `node_modules`ä¸è·³è½¬

`vuePlugin`: **æ´‹è‘±æ¨¡å‹**ä¸­ï¼Œå¤„ç†SFCç»„ä»¶ï¼Œtsè°ƒç”¨`esbuild`åšå¤„ç†ï¼ˆ**sourcemapå¤±æ•ˆï¼Œæ²¡æœ‰åˆå¹¶**ï¼‰

`esbuildPlugin`: **æ´‹è‘±æ¨¡å‹**ä¸­ï¼Œè½¬æ¢`.ts`æ–‡ä»¶ï¼Œä¸”è°ƒç”¨äº†`genSourceMapString`ï¼Œæœ‰æ•ˆçš„`sourcemap`

`jsonPlugin`: **æ´‹è‘±æ¨¡å‹**ä¸­è½¬æ¢`json`ä¸º`esm`è¯­æ³•çš„å¯¹è±¡

`cssPlugin`:  ç›‘å¬cssæ–‡ä»¶å˜åŠ¨ï¼ˆéSFCçš„srcï¼Œè¿™åœ¨`vuePlugin`ä¸­å¤„ç†å˜åŠ¨ï¼Œå³æ†ç»‘cssä¸SFCæ–‡ä»¶å…³ç³»ï¼Œcssæ–‡ä»¶å˜åŠ¨ï¼Œè·å–SFCè·¯å¾„åè®¾ç½®idï¼Œè§¦å‘`vue-style-update`ï¼Œæ›´æ–°`<link href="XXX">`çš„`href`é“¾æ¥ï¼‰ï¼Œç›‘å¬`config.transforms`å˜åŠ¨ï¼›**æ´‹è‘±æ¨¡å‹**ä¸­å¤„ç†importç±»`.modules.css`esmåŒ–ã€cssé¢„å¤„ç†å™¨

`assetPathPlugin`: **æ´‹è‘±æ¨¡å‹**ä¸­ï¼Œè¯†åˆ«åˆ°æ˜¯`import`é™æ€èµ„æºç±»å‹çš„è¯·æ±‚ï¼Œå°†æ•°æ®esmåŒ–

`ServerTransformPlugin`ï¼šæ ¹æ®`config.transform`åŠ¨æ€åˆ›å»ºï¼Œä¸€ä¸ªä»£ç è½¬æ¢å™¨ï¼Œ**viteç‰¹æ€§æ’ä»¶**ï¼Œå‡¡æ˜¯ç»è¿‡è¯¥æ’ä»¶å¤„ç†çš„ï¼Œ`koa.ctx`ä¸Šä¸‹æ–‡ä¼šå¸¦æœ‰`_transformed = true`å±æ€§;**æ´‹è‘±æ¨¡å‹**ä¸­æ‹…å½“ç”¨æˆ·è‡ªå®šä¹‰è½¬æ¢ä»£ç çš„èŒè´£ã€‚

> è¿™é‡ŒæŒ‡çš„é‡Œå±‚æ˜¯æ¯”å¤–å±‚å…ˆæ‰§è¡Œ

#### è¡¥å……[eab49a4](https://github.com/Kingbultsea/vite-analysis/blob/ea4fb552986c95f4da44839e03a00192ce424139/291-300/291-300.md)ï¼Œæå‡`hmrPlugin`åˆ°å†…ç½®æ’ä»¶ç¬¬ä¸€å±‚çš„åŠ¨æœº

`WebSocket`åˆå§‹åŒ–ï¼Œ`watcher`å‚æ•°åˆå§‹åŒ–ã€‚

ä¸ºä»€ä¹ˆç”¨æˆ·çš„pluginsæ˜¯ç¬¬ä¸€å±‚ï¼Ÿè¦†ç›–ç”¨æˆ·å¯¹`watcher`çš„å®šä¹‰ï¼ˆæ˜¯çš„ï¼Œæˆ‘æƒ³ä¸å‡ºå…¶ä»–å½±å“äº†ï¼‰ã€‚

```typescript
// start a websocket server to send hmr notifications to the client
  const wss = new WebSocket.Server({ server })
  const sockets = new Set<WebSocket>()

  wss.on('connection', (socket) => {
    debugHmr('ws client connected')
    sockets.add(socket)
    socket.send(JSON.stringify({ type: 'connected' }))
    socket.on('close', () => {
      sockets.delete(socket)
    })
  })

  wss.on('error', (e: Error & { code: string }) => {
    if (e.code !== 'EADDRINUSE') {
      console.error(chalk.red(`[vite] WebSocket server error:`))
      console.error(e)
    }
  })

  watcher.handleVueReload = handleVueReload
  watcher.handleJSReload = handleJSReload
  watcher.send = send
```

> æˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ªæå‡æ²¡ä»€ä¹ˆå®é™…ä½œç”¨ï¼Œæå‰å»ºç«‹WebSocketç½¢äº†ã€‚

### æ–°å¢ä¸ƒ

**è§„èŒƒ**viteç‰¹è‰²æ’ä»¶ï¼Œè¿™ä¸¤ä¸ªæ’ä»¶éƒ½ä¼šè¢«ä¸¢è¿›æ’ä»¶ç»„ä¸­ã€‚

dev: `...(transforms.length ? [createServerTransformPlugin(transforms)] : [])`

build: `...(transforms.length ? [createBuildJsTransformPlugin(transforms)] : [])`

> as?: 'js' | 'css' // ç±»å‹ï¼Œå¦‚æ˜¯css å°†ä¼šä¸sPlugin buildPluginCssä¸€åŒå¤„ç†ï¼ŒserverPluginHmrä»…ä»…æ˜¯è¿‡æ»¤æ‰è¿™äº›å®é™…æ˜¯cssçš„æ–‡ä»¶ï¼Œå°±æ€•å…¶ä»–æ–‡ä»¶ä¹Ÿå¼•å…¥äº†è§¦å‘äº†handleJSReloadï¼ˆ**å°¤å¤§é˜²äº†ä¸€æ‰‹**~ï¼‰ã€‚
>
> test.query åœ¨devä¸­ä¼šæºå¸¦æ—¶é—´å‚æ•°t

```typescript
import { ServerPlugin } from './server'
import { Plugin as RollupPlugin } from 'rollup'
import { parseWithQuery, readBody, isImportRequest } from './utils'

export interface Transform {
  /**
   * @default 'js'
   */
  as?: 'js' | 'css' // ç±»å‹ï¼Œå¦‚æ˜¯css å°†ä¼šä¸sPlugin buildPluginCssä¸€åŒå¤„ç†
  test: (
    path: string,
    query: Record<string, string | string[] | undefined> // è·¯å¾„å‚æ•° import a from 'a.css?a=2' åœ¨devä¸­ä¼šæºå¸¦æ—¶é—´å‚æ•°t
  ) => boolean
  transform: (code: string, isImport: boolean) => string | Promise<string>
}

export function normalizeTransforms(transforms: Transform[]) {}

// viteç‰¹æ€§çš„koaæ’ä»¶
export function createServerTransformPlugin(
  transforms: Transform[]
): ServerPlugin {
  return ({ app }) => {
    app.use(async (ctx, next) => {
      await next()
      for (const t of transforms) {
        if (t.test(ctx.path, ctx.query)) {
          ctx.type = t.as || 'js'
          if (ctx.body) {
            const code = await readBody(ctx.body)
            if (code) {
              ctx.body = await t.transform(code, isImportRequest(ctx))
              ctx._transformed = true
            }
          }
        }
      }
    })
  }
}

// rollupçš„æ’ä»¶
export function createBuildJsTransformPlugin(
  transforms: Transform[]
): RollupPlugin {
  transforms = transforms.filter((t) => t.as === 'js' || !t.as)

  return {
    name: 'vite:transforms',
    async transform(code, id) {
      const { path, query } = parseWithQuery(id)
      for (const t of transforms) {
        if (t.test(path, query)) {
          return t.transform(code, true)
        }
      }
    }
  }
}
```

![devä¸‹çš„timestampå‚æ•°t](3.png)

### æ€»ç»“

æ·»åŠ transformä¸ºäº†å¼€å‘è€…æ›´åŠ ä¾¿æ·ï¼Œç”¨rollupæ’ä»¶å’Œviteç‰¹è‰²çš„koaæ’ä»¶ä¹Ÿå¯ä»¥â€œå®Œæˆâ€ï¼Œä½†æ˜¯éš¾åº¦å·¨å¤§ï¼Œæ¯”å¦‚as: csså–æ¶ˆhmræ˜¯åšä¸åˆ°çš„ï¼Œè·¨æ’ä»¶æ˜¯ä¸å¯èƒ½å®Œæˆçš„ã€‚

é¡ºå¸¦ä¸€æï¼Œviteç‰¹è‰²æ’ä»¶æ–‡ä»¶æ˜¯ä¸ä¼šè¢«æ·»åŠ è¿›hmrçš„ï¼Œæ¯æ¬¡ä¿®æ”¹éœ€è¦é‡æ–°æ‰“å¼€æœåŠ¡ï¼ˆå¯èƒ½æœ‰ç‚¹éš¾ä»¥å°æ”¹åŠ¨åšåˆ°ï¼ŒæŠŠè¿™äº›æ’ä»¶çš„è·¯å¾„ä¿å­˜èµ·æ¥ï¼Œhmræ–°å¢ä¸€ä¸ªhandleVitePluginï¼Œéœ€è¦æ›´æ–°å·²ç»è°ƒç”¨çš„`app.use`ï¼‰ã€‚



# 337 - bf4d394 [#110](https://github.com/vitejs/vite/pull/110) ä»£ç æ•´ç†

![4](4.png)



# 338 - [#113](https://github.com/vitejs/vite/pull/110) fix: transformåº”è¯¥è°ƒç”¨æ‰€æœ‰çš„æ’ä»¶

ç®—æ˜¯ä¸ªå°å¤±è¯¯ã€‚

```typescript
# node/transform.ts  createBuildJsTransformPlugin
for (const t of transforms) {
    if (t.test(path, query)) {
      return t.transform(code, true)
    }
}

// ä¿®æ”¹åï¼š
let result: string | Promise<string> = code
  for (const t of transforms) {
    if (t.test(path, query)) {
      result = await t.transform(result, true)
    }
}
return result
```



# 339 - 9adbfdb ä¿®å¤æµ‹è¯•ç¯å¢ƒä¸‹çš„tsconfig

![5](5.png)

è§£å†³ç¼–è¾‘å™¨æç¤ºæŠ¥é”™ï¼š

![6](6.png)



# 340 - d6dd2f0

æ”¹åŠ¨éƒ¨åˆ†ï¼š

- `node/server/serverPluginVue.ts`: `generateCodeFrame`ç»Ÿä¸€åœ¨`resolveCompiler`æ–¹æ³•ä¸­è·å–ã€‚
- `node/esbuildService.ts`: æ‡’åŠ è½½`generateCodeFrame`ï¼ˆç›´æ¥åŒ…å†…è·å–ï¼‰ã€‚
