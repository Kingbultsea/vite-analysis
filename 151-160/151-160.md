# commit-151 处理`<script src`

1. 构建模式下，使用正则匹配出`src`里面的内容`<script src="main.js">`

```typescript
const srcRE = /\bsrc=(?:"([^"]+)"|'([^']+)'|([^'"\s]+)\b)/

// `src="main.js"`.match(srcRE) -> main.js
// 'src=main.js'  .match(srcRE) -> main.js
// `src='main.js'`.match(srcRE) -> main.js
```

2. 添加import "main.js"
3. 与`<script>`里的内容一起合并后返回



# commit-152 支持能分析按需加载类型`import` id

## node/serverPluginModuleRewrite.ts

```typescript
imports.forEach(({ s: start, e: end, d: dynamicIndex }) => {
    let id = source.substring(start, end)
    if (dynamicIndex >= 0) {
          console.log(id)
          
        
          const literalIdMatch = id.match(/^(?:'([^']+)'|"([^"]+)")$/)
          console.log(literalIdMatch)
          /*
          [
            "'./foo.js'",
            './foo.js',
            undefined,
            index: 0,
            input: "'./foo.js'",
            groups: undefined
          ]
           */
        
        
          if (literalIdMatch) {
            hasLiteralDynamicId = true
            id = literalIdMatch[1] || literalIdMatch[2]
          }
    }
}
```

## 什么是按需加载？

```typescript
import('./foo.js').then(mod => {
  console.log(mod.default)
})
```

## 和直接import有什么不一样？

AST中返回的id会多了引号。

## bug

`transformAssetUrlsBase: path.posix.dirname(publicPath)`导致了错误，这部分代码已回滚到
` transformAssetUrls: false`



# commit-153 支持`json`格式的引入

## 构建方面

引入新的rollup插件：`@rollup/plugin-json`

## dev方面

实际上`json`文件默认静态资源用`serverPluginServeStatic.ts`来处理，新增`serverPluginJson.ts`，目的是改写成对象。

```typescript
import { Plugin } from './server'
import { readBody } from './utils'

export const jsonPlugin: Plugin = ({ app }) => {
  app.use(async (ctx, next) => {
    await next()
      
    // handle .json imports
    if (ctx.path.endsWith('.json')) {
      const referer = ctx.get('referer')
      
      console.log(referer)
      // http://localhost:3000/Comp.vue 
      
      // 仅在请求页面不为.html才改写
      if (/\.\w+$/.test(referer) && !referer.endsWith('.html')) {
        ctx.type = 'js'
        ctx.body = `export default ${await readBody(ctx.body)}`
      }
    }
  })
}
```

## `json`文件有`hmr`吗？

不支持，得手动刷新页面，想支持还是使用`js`对象吧。



# commit-154 调整`node/utils.ts`

新增`isImportRequest`，该方法是在`serverPluginServeStatic.ts`中抽离出来的。

```typescript
export const isImportRequest = (ctx: Context) => {
  const referer = ctx.get('referer')
  return /\.\w+$/.test(referer) && !referer.endsWith('.html')
}
```

暴露所有`utils.ts`的方法。

```typescript
# node/index.ts
export * from './server'
export * from './build'

// before export { cachedRead, isStaticAsset } from './utils'
export * from './utils'
```



# commit-155 支持在`js`中使用`import css`文件

新增`serverPluginCss.ts`。

1. 处理`.css`后缀文件，且不带参数`raw`

2. 转换成`js`

3. 被转换的`js`文件调用`updateStyle`

4. 更换`link`(`updateStyle`做的事情，之前的文章有讲解)

   ```typescript
   function updateStyle(id: string, url: string) {
     const linkId = `vite-css-${id}`
     let link = document.getElementById(linkId)
     if (!link) {
       link = document.createElement('link')
       link.id = linkId
       link.setAttribute('rel', 'stylesheet')
       link.setAttribute('type', 'text/css')
       document.head.appendChild(link)
     }
     link.setAttribute('href', url)
   }
   ```

   

```typescript
import { Plugin } from './server'
import { isImportRequest } from './utils'
import { hmrClientId } from './serverPluginHmr'
import hash_sum from 'hash-sum'

export const cssPlugin: Plugin = ({ app }) => {
  app.use(async (ctx, next) => {
    await next()
    // handle .css imports
    // we rewrite it to JS that injects a <style> tag pointing to the same url
    // but with a `?raw` query which returns the actual css
    if (
      ctx.path.endsWith('.css') &&
      isImportRequest(ctx) &&
      // note ctx.body could be null if upstream set status to 304
      ctx.body &&
      // skip raw requests
      !ctx.query.raw
    ) {
      ctx.type = 'js'
      const id = JSON.stringify(hash_sum(ctx.path))
      const rawPath = JSON.stringify(ctx.path + '?raw')
      ctx.body = `
import { updateStyle } from "${hmrClientId}"\n
updateStyle(${id}, ${rawPath})
`.trim()
    }
  })
}
```



# commit-156 支持`import css hmr`功能

## `node/serverPluginCss.ts`

```typescript
// handle hmr
  watcher.on('change', (file) => {
    if (file.endsWith('.css')) {
      const publicPath = resolver.fileToRequest(file)
      const id = hash_sum(publicPath)
      watcher.send({
        type: 'style-update',
        id,
        path: publicPath,
        timestamp: Date.now()
      })
    }
  })
```

## `hmr`事件类型

更名：
`vue-style-remove` -> `style-remove`

``vue-style-update` -> `style-update`

```typescript
interface HMRPayload {
  type:
    | 'vue-rerender'
    | 'vue-reload'
    | 'vue-style-update'
    | 'js-update'
    | 'style-update'
    | 'style-remove'
    | 'full-reload'
    | 'custom' // 用户自定义事件 这个我们还没有深入应用
  timestamp: number
  path?: string
  id?: string
  index?: number
  customData?: any
}
```



# commit-157 v0.9.0

release v0.9.0