# 241 - 5f05f1e 简化`web_modules`路径处理器

改动：

- `node/serverPluginModuleResolve.ts`，`resolveWebModule`被重构（详 **改动一**）

## 改动一

```typescript
async function resolveWebModule(
  root: string,
  id: string
): Promise<string | undefined> {
  let webModulePath = webModulesMap.get(id)
  if (webModulePath) {
    return webModulePath
  }
  webModulePath = path.join(root, 'web_modules', id + '.js')
  if (await fs.pathExists(webModulePath)) {
    webModulesMap.set(id, webModulePath)
    return webModulePath
  }
}
```

## 什么是`webModules`?

使用方式：

创建文件夹`web_modules`，在文件夹下创建`webmodules.js`，使用`import 'webmodules'`引入。

```typescript
// # Comp.vue
import 'webmodules'
```

所以从功能和代码上看，作用仅仅是路径转换。

> 该功能仅支持dev开发，目前没有任何构建代码。



# 242 - e01e26d `url('data:')`应跳过处理

改动：

`node/buildPluginCss.ts`，转换`url(./foo.png)`为资源的处理器，应跳过对`url(data:)` `inlineData`的处理。



# 243 - fc75323 修复`web_modules`在构建中无法使用的问题

改动部分：

- `node/buildPluginResolve.ts`，引入`node/serverPluginModuleResolve.ts`中的`resolveWebModule`方法。（详 **改动一**）

## 改动一

修改`resolveId`为异步方式，因不依赖其他插件`resolveId`的处理，所以可以异步。

如果检测到路径非`@`且非`/`，则执行`resolveWebModule`，没有寻找到`web_module`即空，不做任何处理。

也就是说检测`import a from 'myLodash'`，尝试寻找`web_module/myLodash.js`，有则转换为`import a from 'web_module/myLodash.js'`。

> 顺带一提，rollup已经帮忙处理好node_modules了，我们不用管这一层东西

```typescript
async resolveId(id: string) {
      if (id === hmrClientId) {
        return hmrClientId
      } else if (id.startsWith('/')) {
        // if id starts with any of the src root directories, it's a file request
        if (srcRoots.some((root) => id.startsWith(root))) {
          return
        }
        const resolved = resolver.requestToFile(id)
        debug(id, `-->`, resolved)
        return resolved
      } else if (id === 'vue') {
        if (!cdn) {
          return resolveVue(root).bundler
        } else {
          return {
            id: resolveVue(root).cdnLink,
            external: true
          }
        }
      } else if (!id.startsWith('.')) {
        const request = resolver.idToRequest(id)
        if (request) {
          const resolved = resolver.requestToFile(request)
          debug(id, `-->`, request, `--> `, resolved)
          return resolved
        } else {
          const webModulePath = await resolveWebModule(root, id)
          if (webModulePath) {
            return webModulePath
          }
        }
      }
    }
```



# 244 - 7aaf458 兼容[#59](https://github.com/vitejs/vite/pull/59)，定义构建字符串的范围

改动部分：

- `node/build.ts`对`@rollup/plugin-replace`(替换字符串)插件配置范围为`['**/*.js', '**/*.ts', '**/*.jsx', '**/*.tsx']`。
- `node/buildPluginResolve.ts`对返回的`hot`，增加`accept` `on`，主要是为了调用的时候为空的问题（[#59](https://github.com/vitejs/vite/pull/59)）。



# 245 - 6490a8d 添加`playground`测试项目

用于检测`vite`的BUG。

包含：

- `web_modules`

- `@hmr`使用

- 模块处理

- `hmr`

- `.css`引入

- `scope css`

- `.module.css`

- `template`预处理器`pug`

- 行内式资源，`url()`外链资源

- `JSON`引入

- `JSX` `TSX`应用

- `async`组件

  

# 246 - d02d694 完善功能测试