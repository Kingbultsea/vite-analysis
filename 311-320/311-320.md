# 311 - c18451d 构建：简化tsconfig

改动部分：

`tsconfig.base.json`：去除默认选项，`esModuleInterop`开启后，`allowSyntheticDefaultImports`会为`true`。

![1](1.png)

[tsconfig](https://www.tslang.cn/docs/handbook/compiler-options.html)

[esModuleInterop](https://zhuanlan.zhihu.com/p/148081795) [allowSyntheticDefaultImports](https://blog.leodots.me/post/40-think-about-allowSyntheticDefaultImports.html): 兼容esm引入cjs

`noImplicitAny`：在表达式和声明上有隐含的 `any`类型时报错，默认`alse`

`strictNullChecks`: 在严格的 `null`检查模式下， `null`和 `undefined`值不包含在任何类型里，只允许用它们自己和 `any`来赋值（有个例外， `undefined`可以赋值到 `void`），默认`false`。

`strict`: 启用所有严格类型检查选项。

`noUnusedLocals`:  若有未使用的局部变量则抛错。



# 312 - 0708279 重构[#97](https://github.com/vitejs/vite/pull/95)，且全局注册importer与importee关系，即设置`importerMap`

在[309 - 7ffa9c0](https://github.com/Kingbultsea/vite-analysis/blob/master/301-310/301-310.md#309---7ffa9c0-97-windows-hmr)，修复了windows路径改写。

改动部分：

- 因为`resolveImport`方法已经处理过绝对路径，所以现在去除重复的逻辑代码。

- `handleJSReload`会读取`importerMap`作为检测，才会调用`walkImportChain`检测`hmrAcceptanceMap`，才能够触发`js-update`，现在把注册`importerMap`的逻辑放进`serverPluginHmr.ts registerDep`中。

这块有很多坑，`accept`被调用一次以上，新的将会覆盖旧的，`client.ts`处理`hot-accept`用了key value对应关系; importer调用自身作为importee，触发`js-update`，如果其他文件或者组件引入了该文件，将感受不到任何变化（合理？只能在文档中约束不要import使用了HMR API的js文件了）。

> importerMap存放所有文件的importer和importee的关系。
>
> hmrAcceptanceMap存放使用了hot.accept的importer和importee的关系，用于触发`js-update`，提高hmr性能体验。

### 关于function的参数风格

之前查阅`vue-next`也发现很少使用解构（或没有），`Vite`里面是完全没有的。

解构可以使我们打乱参数顺序，但是不能变换名称，而且写类型的时候会有重复字段。

```typescript
export const resolveImport = (
  importer: string,
  id: string,
  resolver: InternalResolver,
  timestamp?: string
): string => {}

export const resolveImport = ({
  importer,
  id,
  resolver,
  timestamp
}: {
  importer: string
  id: string
  resolver: InternalResolver
  timestamp?: string
}): string => {}
```



# 313 - 5ae6278 changelog

## [0.13.1](https://github.com/vuejs/vite/compare/v0.13.0...v0.13.1) (2020-05-09)

### Bug Fixes

- **hmr:** 修复hot.accept() 路径改写（windows下） ([#97](https://github.com/vuejs/vite/issues/97)) ([7ffa9c0](https://github.com/vuejs/vite/commit/7ffa9c0b953f4a78251a8c379a2edf8e31fd368b))
- 修复web_modules后缀添加问题 + 在非`jsx`文件下使用`jsx`将会发出警告（反正`es-module-lexer`包报错了就提示是这个错） ([3653793](https://github.com/vuejs/vite/commit/3653793a2f713b126aaefb01b00878614fc4c63c)), closes [#94](https://github.com/vuejs/vite/issues/94)

### Features

- **build:** 输出`brotli-compressed`压缩下的文件大小 ([#95](https://github.com/vuejs/vite/issues/95)) ([b7f5ad2](https://github.com/vuejs/vite/commit/b7f5ad245f10efac89be0954155639e310c46e00))

